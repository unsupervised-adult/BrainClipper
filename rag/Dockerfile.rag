# RAG Mode Dockerfile
FROM nvidia/cuda:12.8.0-base-ubuntu22.04

ARG DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    build-essential \
    libxml2 \
    libxslt1.1 \
    libxslt1-dev \
    curl \
    nano \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Install Ollama CLI and symlink
RUN curl -fsSL https://ollama.com/install.sh | sh
RUN ln -s /usr/local/bin/ollama /usr/bin/ollama

# Install Python dependencies
RUN pip3 install --no-cache-dir ollama python-evtx sentence-transformers numpy python-dateutil pytz

# Copy RAG and conversion scripts
COPY app/rag.py /app/rag.py
COPY app/convert_mta.py /app/convert_mta.py
COPY app/convert_evtx.py /app/convert_evtx.py
COPY app/rag-entry.sh /app/rag-entry.sh
COPY app/rag_cli.py /app/rag_cli.py

WORKDIR /app

# Make entry script executable
RUN chmod +x /app/rag-entry.sh

# Symlink scripts for consistency
RUN ln -s /app/rag-entry.sh /usr/local/sbin/rag-entry.sh \
    && ln -s /app/rag.py /usr/local/sbin/rag.py \
    && ln -s /app/convert_mta.py /usr/local/sbin/convert_mta.py \
    && ln -s /app/convert_evtx.py /usr/local/sbin/convert_evtx.py \
    && ln -s /app/rag_cli.py /usr/local/sbin/rag_cli.py

ENTRYPOINT ["/app/rag-entry.sh"]
